---
title: perf性能分析
date: 2019-10-09 07:54:19
categories:
- 工具
tags:
- go
---

# 1 介绍
Perf是用于软件性能分析的工具，通过Perf，应用程序可以利用PMU，tracepoint和内核中的特殊计数器进行性能统计。Perf不但可以分析应用程序的性能问题(per thread)，也可以分析内核的性能问题，处理所有性能相关的事件：程序运行期间的硬件事件，如instructions retired ，processor clock cycles等；软件事件，如Page Fault和进程切换。  

Perf可以计算每个时钟周期内的指令数IPC，IPC偏低表明代码没有很好地利用CPU；Perf还可以对程序进行函数级别采样，从而了解程序的性能瓶颈；Perf还可以替代strace，可以添加动态内核probe点，还可以做benchmark衡量调度器的好坏。  

# 2 安装
1 二进制包安装  
yum install perf  

2 源码安装  
* 查看内核版本：uname -a，Linux 10-62-81-197 3.10.107-1-tlinux2-0046
* 下载linux内核对应的源码：[Linux源码](https://github.com/torvalds/linux/releases)
* 进入tools/perf目录，执行make&&make install

# 3 预备知识
## 3.1 硬件特性之Cache
内存读写非常快，但还是无法和处理器的指令执行速度相比，为了从内存中读取指令和数据，处理器需要等待，从处理器的角度来看，这种等待非常漫长。Cache是一种SRAM，它的读写速度和处理器的速度相当，因此将常用的数据保存在Cache中，处理器便无需等待，Cache一般比较小，充分利用Cache是软件调优的重要部分。  

## 3.2 硬件特性之流水线，超标量体系结构，乱序执行
提高性能最有效的方式之一就是并行，处理器在硬件设计时也尽可能地并行，比如流水线，超标量体系结构以及乱序执行。处理器处理一条指令需要分多个步骤完成，先取指令，然后完成运算，最后将计算结果输出到总线，在处理器内部，这可以看作一个三级流水线。  

超标量(superscalar)指一个时钟周期发射(issue)多条指令的流水线机器架构，如Inte的Pentium处理器，内部有两个执行单元，在一个时钟周期内允许执行两条指令。

此外，在处理器内部不同指令所需要的处理步骤和时钟周期是不同的，如果严格按照程序的执行顺序执行，那么就无法充分利用处理器的流水线，因此指令有可能被乱序执行。

上述三种并行技术对所执行的指令有一个基本要求，即相邻的指令相互没有依赖关系。假如某条指令需要依赖前面一条指令的执行结果数据，那么pipeline便失去作用，因为第二条指令必须等待第一条指令完成。因此好的软件必须尽量避免生成这种代码。  

## 3.3 硬件特性之分支预测
